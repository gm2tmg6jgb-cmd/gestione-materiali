<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Materiali</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="supabase.config.js"></script>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --blue-50: #eff6ff; --blue-600: #2563eb;
    --indigo-50: #eef2ff; --indigo-600: #4f46e5; --indigo-700: #4338ca; --indigo-800: #312e81;
    --purple-600: #9333ea;
    --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db;
    --gray-600: #4b5563; --gray-700: #374151; --gray-900: #111827;
    --green-600: #16a34a; --red-600: #dc2626;
}
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, var(--blue-50), var(--indigo-50)); color: var(--gray-900); line-height: 1.5; }
.sticky-header { position: sticky; top: 0; z-index: 50; background: white; border-bottom: 1px solid var(--gray-200); box-shadow: 0 1px 2px rgba(0,0,0,.05); }
.header-content { max-width: 100%; padding: 1.5rem 1rem; }
.header-flex { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
.header-left { display: flex; align-items: center; gap: 0.75rem; }
.header-title { font-size: 1.875rem; font-weight: 700; }
.header-subtitle { font-size: 0.875rem; color: var(--gray-600); }
.header-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.tab-btn { padding: 0.5rem 1rem; border: 1px solid var(--gray-300); background: white; border-radius: 0.5rem; cursor: pointer; font-weight: 500; }
.tab-btn.active { background: var(--indigo-600); color: white; border-color: var(--indigo-600); }
.main-container { padding: 2rem 1rem; }
.filter-panel { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,.1); padding: 1.5rem; margin-bottom: 2rem; }
.filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
.filter-group { display: flex; flex-direction: column; }
.filter-label { font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem; }
.filter-input, .filter-select { padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 0.5rem; font-size: 0.875rem; }
.filter-input:focus, .filter-select:focus { outline: none; box-shadow: 0 0 0 2px var(--indigo-600); }
.button-primary { background: var(--indigo-600); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 500; }
#csv-file { display: none; }
.turno-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(550px, 1fr)); gap: 2rem; margin-top: 2rem; }
.turno-card { background: white; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,.1); border-top: 4px solid; }
.turno-card-a { border-top-color: #3b82f6; }
.turno-card-b { border-top-color: #10b981; }
.turno-card-c { border-top-color: #f59e0b; }
.turno-card-d { border-top-color: #ef4444; }
.turno-header { padding: 1.5rem; background: linear-gradient(135deg, rgba(0,0,0,.02), rgba(0,0,0,.05)); border-bottom: 1px solid var(--gray-200); }
.turno-title { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
.turno-stats { width: 100%; }
.stat-badge { background: var(--gray-100); padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; }
.stat-badge-label { color: var(--gray-600); font-size: 0.75rem; margin-bottom: 0.25rem; }
.stat-badge-value { font-size: 1.25rem; font-weight: 700; }
.turno-content { padding: 1.5rem; overflow-y: auto; max-height: 600px; }
.items-table { width: 100%; border-collapse: collapse; }
.items-table th { background: var(--gray-100); padding: 0.75rem; text-align: left; font-weight: 600; font-size: 0.875rem; color: var(--gray-700); border-bottom: 2px solid var(--gray-300); }
.items-table th:nth-child(2), .items-table th:nth-child(3), .items-table th:nth-child(4), .items-table th:nth-child(5) { text-align: center; }
.items-table td { padding: 0.75rem; border-bottom: 1px solid var(--gray-200); font-size: 0.85rem; }
.items-table td:nth-child(2), .items-table td:nth-child(3), .items-table td:nth-child(4), .items-table td:nth-child(5) { text-align: center; }
.items-table tr:hover { background: var(--gray-50); }
.item-progetto { font-weight: 600; color: var(--indigo-600); }
.item-componente { font-weight: 600; color: var(--purple-600); }
.item-material { font-family: monospace; font-weight: 500; }
.item-qty { display: flex; align-items: center; justify-content: center; gap: 0.3rem; font-weight: 700; }
.check-mark { color: var(--green-600); font-size: 1.1rem; }
.x-mark { color: var(--red-600); font-size: 1.1rem; }
.qty-ok { color: var(--green-600); }
.qty-fail { color: var(--red-600); }
.page { display: none; }
.page.active { display: block; }
.giorno-card { background: white; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,.1); border-top: 4px solid var(--indigo-600); }
.giorno-header { padding: 1.5rem; background: linear-gradient(135deg, rgba(0,0,0,.02), rgba(0,0,0,.05)); border-bottom: 1px solid var(--gray-200); }
.giorno-title { font-size: 1.5rem; font-weight: 700; color: var(--indigo-800); margin-bottom: 0.5rem; }
.date-info { font-size: 0.875rem; color: var(--gray-600); margin-bottom: 1rem; }
.target-settings { background: var(--gray-50); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; }
.target-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
.target-input-group { display: flex; flex-direction: column; }
.target-input-label { font-size: 0.875rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem; }
.target-input-field { padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 0.5rem; font-size: 0.875rem; }
.target-buttons { display: flex; gap: 0.5rem; }
.progetto-target { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-100); border-radius: 0.5rem; }
.target-item { display: flex; flex-direction: column; }
.target-label { font-size: 0.75rem; color: var(--gray-600); font-weight: 600; margin-bottom: 0.25rem; }
.target-value { font-size: 1.125rem; font-weight: 700; color: var(--indigo-700); }
.target-progress { width: 100%; height: 6px; background: var(--gray-200); border-radius: 3px; margin-top: 0.5rem; overflow: hidden; }
.target-progress-bar { height: 100%; background: linear-gradient(90deg, var(--green-600), #f59e0b); border-radius: 3px; }
.giorno-content { padding: 1.5rem; }
.empty-message { text-align: center; padding: 2rem; color: var(--gray-600); }
.dashboard-table { width: 100%; border-collapse: collapse; font-size: 11px; }
.dashboard-table th { background: #e0e0e0; padding: 4px 3px; text-align: center; border: 1px solid #999; font-weight: bold; height: 20px; }
.dashboard-table td { padding: 4px 3px; border: 1px solid #ccc; text-align: center; height: 20px; }
.dashboard-table .header-level1 { background: #e7e6e6; font-weight: bold; }
.dashboard-table .header-level2 {
    background: #fef2cc;
    font-weight: bold;
    min-width: 80px;
    max-width: 80px;
    width: 80px;
    text-align: center;
}
.dashboard-table .sum-total { background: #f0f0f0; font-weight: bold; }
.anagrafica-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
.anagrafica-table th { background: var(--indigo-600); color: white; padding: 0.6rem 0.8rem; text-align: left; font-weight: 600; border-bottom: 2px solid var(--indigo-800); }
.anagrafica-table td { padding: 0.5rem 0.8rem; border-bottom: 1px solid var(--gray-200); }
.anagrafica-table tr:hover { background: var(--gray-50); }
.anagrafica-table tr:nth-child(even) { background: #f8f9fa; }
@media (max-width: 900px) {
    .turno-grid { grid-template-columns: 1fr; }
    .progetto-target { grid-template-columns: 1fr; }
}
    </style>
</head>
<body>
    <header class="sticky-header">
        <div class="header-content">
            <div class="header-flex">
                <div class="header-left">
                    <div style="font-size: 2rem">ğŸ“Š</div>
                    <div>
                        <h1 class="header-title">Gestione Materiali</h1>
                        <p class="header-subtitle">Progetto | Componente | Materiale | Lavorazione | Prod/Target</p>
                    </div>
                </div>
                <div class="header-buttons">
                    <button class="tab-btn" id="btn-dashboard">ğŸ“Š Dashboard</button>
                    <button class="tab-btn active" id="btn-turni">Turni</button>
                    <button class="tab-btn" id="btn-giorno">Giorno</button>
                    <button class="tab-btn" id="btn-settimana">Settimana</button>
                    <button class="tab-btn" id="btn-mese">Mese</button>
                    <button class="tab-btn" id="btn-preview">ğŸ‘ï¸ Anteprima dati</button>
                    <button class="tab-btn" id="btn-anagrafica">ğŸ—‚ï¸ Anagrafica</button>
                    <button class="tab-btn" id="btn-impostazioni">âš™ï¸</button>
                    <button class="tab-btn" id="btn-import" style="background:#27ae60;color:white;border-color:#27ae60;">ğŸ“‚ Importa File</button>
    <script>
// Inizializzazione Supabase
let supabase = null;
if (typeof SUPABASE_URL !== 'undefined' && SUPABASE_URL && SUPABASE_KEY) {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
}

// === SALVATAGGIO AUTOMATICO SU SUPABASE ===
async function saveToSupabase() {
    if (!supabase) throw new Error('Supabase non configurato');
    if (!DATA || DATA.length === 0) throw new Error('Nessun dato da salvare');
    const datePresenti = [...new Set(DATA.map(r => r.DataAcquisizione).filter(d => d))];
    if (datePresenti.length === 0) throw new Error('Nessuna data trovata nella colonna Acquisito');
    // Cancella record esistenti per le date presenti nel file
    for (const dt of datePresenti) {
        await supabase.from('anagrafica_materiali').delete().eq('DataAcquisizione', dt);
    }
    // Inserisci in chunk da 500 (limite Supabase), senza campo id
    const cleanData = DATA.map(({id, ...rest}) => rest);
    const chunkSize = 500;
    for (let i = 0; i < cleanData.length; i += chunkSize) {
        const chunk = cleanData.slice(i, i + chunkSize);
        const { error } = await supabase.from('anagrafica_materiali').insert(chunk);
        if (error) throw error;
    }
    return datePresenti;
}

async function resetSupabase() {
    if (!supabase) { alert('âš ï¸ Configurazione Supabase mancante'); return; }
    if (!confirm('âš ï¸ ATTENZIONE: Vuoi cancellare TUTTI i dati da Supabase?\nQuesta azione Ã¨ irreversibile!')) return;
    try {
        await supabase.from('anagrafica_materiali').delete().gte('id', 0);
        DATA.length = 0;
        alert('âœ… Tutti i dati sono stati cancellati da Supabase. Database vuoto.');
        renderPreview();
        renderDashboard();
        renderTurni(globalState.turni);
        renderTotale('giorno', globalState.giorno);
    } catch (err) {
        alert('âŒ Errore reset: ' + (err.message || err));
    }
}

// === ANAGRAFICA ASSOCIAZIONI ===
let ANAGRAFICA = [];
let anagraficaSbloccata = false;

async function loadAnagrafica() {
    if (!supabase) return;
    const statusEl = document.getElementById('anagrafica-status');
    if (statusEl) statusEl.textContent = 'â³ Caricamento...';
    try {
        const { data, error } = await supabase.from('anagrafica_associazioni').select('*').order('Progetto');
        if (error) throw error;
        ANAGRAFICA = data || [];
        renderAnagraficaTable();
        if (statusEl) statusEl.textContent = `âœ… ${ANAGRAFICA.length} associazioni caricate`;
    } catch (err) {
        if (statusEl) statusEl.textContent = 'âŒ Errore: ' + (err.message || err);
    }
}

function renderAnagraficaTable() {
    const c = document.getElementById('anagrafica-table');
    if (!c) return;
    if (!ANAGRAFICA || ANAGRAFICA.length === 0) {
        c.innerHTML = '<div class="empty-message">Nessuna associazione presente. Aggiungi righe manualmente o importa da Excel.</div>';
        return;
    }
    const cols = ['Progetto', 'Componente', 'Materiale', 'Reparto', 'CentroDiLavoro', 'Macchina'];
    let html = `<p style="color:#888; font-size:0.85rem; margin-bottom:0.5rem;">${ANAGRAFICA.length} associazioni${anagraficaSbloccata ? ' â€” ğŸ”“ Modifica attiva' : ' â€” ğŸ”’ Bloccata'}</p>`;
    html += '<table class="anagrafica-table"><thead><tr>' + cols.map(k => `<th>${k}</th>`).join('');
    if (anagraficaSbloccata) html += '<th>Azioni</th>';
    html += '</tr></thead><tbody>';
    html += ANAGRAFICA.map(row => '<tr>' + cols.map(k => `<td>${row[k] || ''}</td>`).join('') + (anagraficaSbloccata ? `<td><button onclick="deleteAnagraficaAssociazione(${row.id})" style="color:var(--red-600);border:none;background:none;cursor:pointer;font-size:1.1rem;">ğŸ—‘ï¸</button></td>` : '') + '</tr>').join('');
    html += '</tbody></table>';
    c.innerHTML = html;
}

async function addAnagraficaRow() {
    if (!supabase) { alert('âš ï¸ Configurazione Supabase mancante'); return; }
    const progetto = document.getElementById('ana-progetto').value.trim();
    const componente = document.getElementById('ana-componente').value.trim();
    const materiale = document.getElementById('ana-materiale').value.trim();
    const reparto = document.getElementById('ana-reparto').value.trim();
    const cdl = document.getElementById('ana-cdl').value.trim();
    const macchina = document.getElementById('ana-macchina').value.trim();
    if (!progetto || !materiale) { alert('âš ï¸ Progetto e Materiale sono obbligatori'); return; }
    try {
        const { error } = await supabase.from('anagrafica_associazioni').insert([{
            Progetto: progetto, Componente: componente, Materiale: materiale, Reparto: reparto, CentroDiLavoro: cdl, Macchina: macchina
        }]);
        if (error) throw error;
        document.getElementById('ana-progetto').value = '';
        document.getElementById('ana-componente').value = '';
        document.getElementById('ana-materiale').value = '';
        document.getElementById('ana-reparto').value = '';
        document.getElementById('ana-cdl').value = '';
        document.getElementById('ana-macchina').value = '';
        await loadAnagrafica();
    } catch (err) {
        alert('âŒ Errore: ' + (err.message || err));
    }
}

async function deleteAnagraficaAssociazione(id) {
    if (!confirm('Eliminare questa associazione?')) return;
    try {
        const { error } = await supabase.from('anagrafica_associazioni').delete().eq('id', id);
        if (error) throw error;
        await loadAnagrafica();
    } catch (err) {
        alert('âŒ Errore: ' + (err.message || err));
    }
}

async function importAnagraficaExcel(file) {
    const statusEl = document.getElementById('anagrafica-status');
    const reader = new FileReader();
    reader.onload = async (ev) => {
        try {
            const workbook = XLSX.read(ev.target.result, {type: 'binary'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, {defval: ''});
            const tutteRighe = json.map(row => {
                const materiale = row['Materiale'] || row['materiale'] || '';
                let progetto = row['Progetto'] || row['progetto'] || '';
                if (!progetto && materiale) {
                    if (materiale.startsWith('251')) progetto = 'DCT 300';
                    else if (materiale.startsWith('M015') || materiale.startsWith('M017')) progetto = '8Fe';
                    else if (materiale.startsWith('M016')) progetto = 'DCT Eco';
                    else progetto = 'Altro';
                }
                return {
                    Progetto: progetto,
                    Componente: row['Componente'] || row['componente'] || '',
                    Materiale: materiale,
                    Reparto: row['Reparto'] || row['reparto'] || '',
                    CentroDiLavoro: row['CentroDiLavoro'] || row['Centro di lavoro'] || row['centro di lavoro'] || row['Lavorazione'] || row['lavorazione'] || '',
                    Macchina: row['Macchina'] || row['macchina'] || ''
                };
            }).filter(r => r.Materiale);
            // Deduplicazione per Materiale (prende la prima occorrenza)
            const seen = new Set();
            const righe = [];
            tutteRighe.forEach(r => {
                if (!seen.has(r.Materiale)) {
                    seen.add(r.Materiale);
                    if (!ANAGRAFICA.find(a => a.Materiale === r.Materiale)) {
                        righe.push(r);
                    }
                }
            });
            if (righe.length === 0) { statusEl.textContent = 'âš ï¸ Nessuna nuova associazione (tutte giÃ  presenti)'; await loadAnagrafica(); return; }
            const { error } = await supabase.from('anagrafica_associazioni').insert(righe);
            if (error) throw error;
            statusEl.textContent = `âœ… Importate ${righe.length} associazioni uniche (${tutteRighe.length - righe.length} duplicate escluse)`;
            await loadAnagrafica();
        } catch (err) {
            statusEl.textContent = 'âŒ Errore import: ' + (err.message || err);
        }
    };
    reader.readAsBinaryString(file);
}

document.addEventListener('DOMContentLoaded', () => {
    // Carica anagrafica all'avvio
    loadAnagrafica();

    // Tab Anagrafica
    document.getElementById('btn-anagrafica').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        document.getElementById('page-anagrafica').classList.add('active');
        document.getElementById('btn-anagrafica').classList.add('active');
        loadAnagrafica();
    });

    document.getElementById('btn-add-anagrafica').addEventListener('click', () => addAnagraficaRow());
    document.getElementById('btn-load-anagrafica').addEventListener('click', () => loadAnagrafica());

    document.getElementById('btn-unlock-anagrafica').addEventListener('click', () => {
        if (!confirm('Sei sicuro di voler sbloccare l\'anagrafica per modifiche?')) return;
        anagraficaSbloccata = true;
        document.getElementById('anagrafica-edit-panel').style.display = 'block';
        document.getElementById('btn-unlock-anagrafica').style.display = 'none';
        document.getElementById('btn-lock-anagrafica').style.display = 'inline-block';
        renderAnagraficaTable();
    });

    document.getElementById('btn-lock-anagrafica').addEventListener('click', () => {
        anagraficaSbloccata = false;
        document.getElementById('anagrafica-edit-panel').style.display = 'none';
        document.getElementById('btn-unlock-anagrafica').style.display = 'inline-block';
        document.getElementById('btn-lock-anagrafica').style.display = 'none';
        renderAnagraficaTable();
    });
    document.getElementById('file-anagrafica-excel').addEventListener('change', (e) => {
        if (e.target.files[0]) importAnagraficaExcel(e.target.files[0]);
        e.target.value = '';
    });

    // === RESET SUPABASE (tab Anteprima) ===
    document.getElementById('btn-reset-supabase').addEventListener('click', () => resetSupabase());

    // === IMPORTA FILE (header) ===
    document.getElementById('btn-import').addEventListener('click', () => document.getElementById('csv-file').click());

    document.getElementById('btn-test-supabase').addEventListener('click', async () => {
        const status = document.getElementById('supabase-status');
        status.textContent = 'â³ Verifica in corso...';
        if (!supabase) { status.textContent = 'âŒ Configurazione mancante'; return; }
        try {
            const { data, error } = await supabase.from('anagrafica_materiali').select('*').limit(1);
            if (error) { status.textContent = 'âŒ Errore: ' + error.message; }
            else { status.textContent = 'âœ… Connessione OK'; }
        } catch (err) { status.textContent = 'âŒ Errore: ' + (err.message || err); }
    });

    document.getElementById('input-data-supabase').value = new Date().toISOString().slice(0, 10);

    document.getElementById('btn-load-supabase').addEventListener('click', async () => {
        const loadStatus = document.getElementById('supabase-load-status');
        const dataSelezionata = document.getElementById('input-data-supabase').value;
        if (!supabase) { loadStatus.textContent = 'âŒ Configurazione Supabase mancante'; return; }
        if (!dataSelezionata) { loadStatus.textContent = 'âš ï¸ Seleziona una data'; return; }
        loadStatus.textContent = 'â³ Caricamento...';
        try {
            const { data, error } = await supabase.from('anagrafica_materiali').select('*').eq('DataAcquisizione', dataSelezionata);
            if (error) throw error;
            if (!data || data.length === 0) { loadStatus.textContent = 'âš ï¸ Nessun dato trovato per ' + dataSelezionata; return; }
            DATA.length = 0;
            data.forEach(row => {
                DATA.push({
                    Progetto: row.Progetto || '', Materiale: row.Materiale || '', Componente: row.Componente || '',
                    CentroDiLavoro: row.CentroDiLavoro || '', Turno: row.Turno || '', QuantitaTotale: row.QuantitaTotale || 0,
                    Reparto: row.Reparto || '', DataAcquisizione: row.DataAcquisizione || ''
                });
            });
            loadStatus.textContent = `âœ… Caricati ${data.length} record del ${dataSelezionata}`;
            renderPreview();
            renderDashboard();
            renderTurni(globalState.turni);
            renderTotale('giorno', globalState.giorno);
        } catch (err) { loadStatus.textContent = 'âŒ Errore: ' + (err.message || err); }
    });

    document.getElementById('btn-load-all-dates').addEventListener('click', async () => {
        const loadStatus = document.getElementById('supabase-load-status');
        if (!supabase) { loadStatus.textContent = 'âŒ Configurazione Supabase mancante'; return; }
        loadStatus.textContent = 'â³ Recupero date...';
        try {
            const { data, error } = await supabase.from('anagrafica_materiali').select('DataAcquisizione');
            if (error) throw error;
            const dateUniche = [...new Set(data.map(r => r.DataAcquisizione))].filter(d => d).sort().reverse();
            if (dateUniche.length === 0) { loadStatus.textContent = 'âš ï¸ Nessun dato presente su Supabase'; return; }
            loadStatus.textContent = 'ğŸ“… Date disponibili: ' + dateUniche.join(', ') + ' (' + dateUniche.length + ' giorni)';
        } catch (err) { loadStatus.textContent = 'âŒ Errore: ' + (err.message || err); }
    });
});
    </script>
                </div>
            </div>
        </div>
    </header>
    
    <div class="main-container">
        <!-- ANAGRAFICA ASSOCIAZIONI -->
        <div id="page-anagrafica" class="page">
            <div style="background: white; border-radius: 0.5rem; padding: 1.5rem; overflow-x: auto;">
                <h2 style="margin-bottom: 1rem; color: var(--indigo-800);">ğŸ—‚ï¸ Anagrafica Associazioni</h2>
                <p style="color:#666; margin-bottom:1rem;">Tabella fissa di associazione Progetto, Componente, Materiale, Reparto e Centro di Lavoro.</p>
                <!-- Pulsante sblocca/blocca -->
                <div style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
                    <button class="button-primary" id="btn-unlock-anagrafica" style="background:#e74c3c;">ğŸ”’ Sblocca modifica</button>
                    <button class="button-primary" id="btn-lock-anagrafica" style="background:#27ae60; display:none;">ğŸ”“ Blocca anagrafica</button>
                    <span id="anagrafica-status" style="font-weight:600;"></span>
                </div>
                <!-- Form aggiunta manuale (nascosto di default) -->
                <div id="anagrafica-edit-panel" style="display:none;">
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:flex-end; margin-bottom:1rem; padding:1rem; background:#f8f9fa; border-radius:8px;">
                        <div style="display:flex; flex-direction:column; gap:0.2rem;">
                            <label style="font-size:0.8rem; font-weight:600;">Progetto</label>
                            <input type="text" id="ana-progetto" placeholder="es. DCT 300" style="padding:0.4rem; border:1px solid #ccc; border-radius:4px; width:120px;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.2rem;">
                            <label style="font-size:0.8rem; font-weight:600;">Componente</label>
                            <input type="text" id="ana-componente" placeholder="es. DG" style="padding:0.4rem; border:1px solid #ccc; border-radius:4px; width:120px;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.2rem;">
                            <label style="font-size:0.8rem; font-weight:600;">Materiale</label>
                            <input type="text" id="ana-materiale" placeholder="es. 2511122350/S" style="padding:0.4rem; border:1px solid #ccc; border-radius:4px; width:160px;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.2rem;">
                            <label style="font-size:0.8rem; font-weight:600;">Reparto</label>
                            <input type="text" id="ana-reparto" placeholder="es. FRW10217" style="padding:0.4rem; border:1px solid #ccc; border-radius:4px; width:130px;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.2rem;">
                            <label style="font-size:0.8rem; font-weight:600;">Centro di Lavoro</label>
                            <input type="text" id="ana-cdl" placeholder="es. Dentatura" style="padding:0.4rem; border:1px solid #ccc; border-radius:4px; width:140px;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.2rem;">
                            <label style="font-size:0.8rem; font-weight:600;">Macchina</label>
                            <input type="text" id="ana-macchina" placeholder="es. DRA10060" style="padding:0.4rem; border:1px solid #ccc; border-radius:4px; width:130px;">
                        </div>
                        <button class="button-primary" id="btn-add-anagrafica" style="height:34px;">+ Aggiungi</button>
                    </div>
                    <!-- Upload Excel anagrafica -->
                    <div style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
                        <label class="button-primary" style="cursor:pointer; display:inline-block;">
                            ğŸ“‚ Importa da Excel
                            <input type="file" id="file-anagrafica-excel" accept=".xlsx,.xls" style="display:none;">
                        </label>
                        <button class="button-primary" id="btn-load-anagrafica" style="background:var(--indigo-600);">ğŸ”„ Ricarica da Supabase</button>
                    </div>
                </div>
                <!-- Tabella associazioni -->
                <div id="anagrafica-table"></div>
            </div>
        </div>
        <!-- ANTEPRIMA DATI -->
        <div id="page-preview" class="page">
            <div style="background: white; border-radius: 0.5rem; padding: 1.5rem; overflow-x: auto;">
                <h2 style="margin-bottom: 1rem; color: var(--indigo-800);">ğŸ‘ï¸ Anteprima dati caricati</h2>
                <div id="preview-table"></div>
                <div style="margin-top:1.5rem; display:flex; gap:1rem; flex-wrap:wrap; align-items:center;">
                    <button class="button-primary" id="btn-test-supabase">ğŸ”— Test connessione Supabase</button>
                    <button class="button-primary" id="btn-reset-supabase" style="background:#e74c3c;">ğŸ—‘ï¸ Reset completo Supabase</button>
                    <span id="supabase-status" style="margin-left:1rem;font-weight:600;"></span>
                </div>
                <div style="margin-top:1rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
                    <label style="font-weight:600; color:var(--indigo-800);">ğŸ“… Carica dati da Supabase per data:</label>
                    <input type="date" id="input-data-supabase" style="padding:0.4rem 0.8rem; border:1px solid #ccc; border-radius:6px; font-size:0.95rem;">
                    <button class="button-primary" id="btn-load-supabase">ğŸ“¥ Carica da Supabase</button>
                    <button class="button-primary" id="btn-load-all-dates" style="background:var(--indigo-600);">ğŸ“‹ Vedi tutte le date</button>
                    <span id="supabase-load-status" style="font-weight:600;"></span>
                </div>
            </div>
        </div>
        <!-- DASHBOARD -->
        <div id="page-dashboard" class="page">
            <div class="filter-panel">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">ğŸ­ Macchina</label>
                        <select class="filter-select" id="mach-dashboard"></select>
                    </div>
                </div>
            </div>
            <div style="margin-bottom:8px;">
                <button onclick="debugDashboard()" style="padding:6px 14px;background:#ff9800;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:13px;">ğŸ” Debug Dashboard</button>
                <span id="debug-dashboard-info" style="margin-left:10px;font-size:12px;color:#666;"></span>
            </div>
            <div style="background: white; border-radius: 0.5rem; padding: 1.5rem; overflow-x: auto;">
                <table class="dashboard-table" id="dashboard-table"></table>
            </div>
        </div>
        
        <!-- TURNI -->
        <div id="page-turni" class="page active">
            <div class="filter-panel">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“… Data</label>
                        <input type="date" class="filter-input" id="date-turni">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ” Ricerca</label>
                        <input type="text" class="filter-input" id="search-turni" placeholder="Materiale...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ­ Reparto</label>
                        <select class="filter-select" id="rep-turni"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“ Progetto</label>
                        <select class="filter-select" id="prog-turni"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“¦ Componente</label>
                        <select class="filter-select" id="comp-turni"></select>
                    </div>
                </div>
            </div>
            <input type="file" id="csv-file" accept=".csv,.tsv,.xls,.xlsx">
            <div class="turno-grid" id="turno-grid"></div>
        </div>
        
        <!-- GIORNO -->
        <div id="page-giorno" class="page">
            <div class="filter-panel">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“… Data</label>
                        <input type="date" class="filter-input" id="date-giorno">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ” Ricerca</label>
                        <input type="text" class="filter-input" id="search-giorno" placeholder="Materiale...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ­ Reparto</label>
                        <select class="filter-select" id="rep-giorno"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“ Progetto</label>
                        <select class="filter-select" id="prog-giorno"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“¦ Componente</label>
                        <select class="filter-select" id="comp-giorno"></select>
                    </div>
                </div>
            </div>
            <div class="giorno-card">
                <div class="giorno-header">
                    <div class="giorno-title">ğŸ“… Totale Giornaliero</div>
                    <div class="date-info" id="date-info-giorno"></div>
                    <div class="progetto-target" id="progetto-target"></div>
                </div>
                <div class="giorno-content" id="giorno-content"></div>
            </div>
        </div>
        
        <!-- SETTIMANA -->
        <div id="page-settimana" class="page">
            <div class="filter-panel">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“… Inizio</label>
                        <input type="date" class="filter-input" id="date-start-settimana">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ” Ricerca</label>
                        <input type="text" class="filter-input" id="search-settimana" placeholder="Materiale...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ­ Reparto</label>
                        <select class="filter-select" id="rep-settimana"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“ Progetto</label>
                        <select class="filter-select" id="prog-settimana"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“¦ Componente</label>
                        <select class="filter-select" id="comp-settimana"></select>
                    </div>
                </div>
            </div>
            <div class="giorno-card">
                <div class="giorno-header">
                    <div class="giorno-title">ğŸ“† Totale Settimanale</div>
                    <div class="date-info" id="date-info-settimana"></div>
                    <div class="progetto-target" id="progetto-target-sett"></div>
                </div>
                <div class="giorno-content" id="settimana-content"></div>
            </div>
        </div>
        
        <!-- MESE -->
        <div id="page-mese" class="page">
            <div class="filter-panel">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“… Mese</label>
                        <input type="month" class="filter-input" id="month-mese">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ” Ricerca</label>
                        <input type="text" class="filter-input" id="search-mese" placeholder="Materiale...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ­ Reparto</label>
                        <select class="filter-select" id="rep-mese"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“ Progetto</label>
                        <select class="filter-select" id="prog-mese"></select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ğŸ“¦ Componente</label>
                        <select class="filter-select" id="comp-mese"></select>
                    </div>
                </div>
            </div>
            <div class="giorno-card">
                <div class="giorno-header">
                    <div class="giorno-title">ğŸ“Š Totale Mensile</div>
                    <div class="date-info" id="date-info-mese"></div>
                    <div class="progetto-target" id="progetto-target-mese"></div>
                </div>
                <div class="giorno-content" id="mese-content"></div>
            </div>
        </div>
        
        <!-- IMPOSTAZIONI -->
        <div id="page-impostazioni" class="page">
            <div class="filter-panel">
                <h2>âš™ï¸ Target Giornalieri</h2>
            </div>
            <div class="target-settings">
                <div class="target-grid" id="target-inputs"></div>
                <div class="target-buttons">
                    <button class="button-primary" id="btn-salva-target">ğŸ’¾ Salva</button>
                    <button class="button-primary" id="btn-reset-target">ğŸ”„ Reset</button>
                </div>
            </div>
            <div style="background: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,.1);">
                <h3 style="margin-bottom: 1rem; color: var(--indigo-800);">ğŸ“‹ Target Attuali</h3>
                <div id="target-summary"></div>
            </div>
        </div>
    </div>
    
    <script>
function renderPreview() {
    const c = document.getElementById('preview-table');
    if (!c) return;
    if (!DATA || DATA.length === 0) {
        c.innerHTML = '<div class="empty-message">Nessun dato caricato</div>';
        return;
    }
    // Costruisci tabella
    const keys = Object.keys(DATA[0]);
    let html = '<table class="dashboard-table"><thead><tr>' + keys.map(k => `<th>${k}</th>`).join('') + '</tr></thead><tbody>';
    html += DATA.map(row => '<tr>' + keys.map(k => `<td>${row[k] || ''}</td>`).join('') + '</tr>').join('');
    html += '</tbody></table>';
    c.innerHTML = html;
}
let DATA = [];



function debugDashboard() {
    const anaMacchine = [...new Set(ANAGRAFICA.map(a => a.Macchina))].sort();
    const dataMateriali = [...new Set(DATA.map(d => d.Materiale))].sort();
    const anaMateriali = [...new Set(ANAGRAFICA.map(a => a.Materiale))].sort();
    const dra = ANAGRAFICA.filter(a => (a.Macchina || '').includes('DRA10116'));
    const sample = DATA.length > 0 ? DATA.slice(0, 3) : [];
    let msg = `=== DEBUG DASHBOARD ===\n`;
    msg += `ANAGRAFICA: ${ANAGRAFICA.length} righe\n`;
    msg += `DATA: ${DATA.length} righe\n\n`;
    msg += `--- Macchine in ANAGRAFICA (prime 15) ---\n${anaMacchine.slice(0,15).join(', ')}\n\n`;
    msg += `--- ANAGRAFICA per DRA10116 ---\n`;
    if (dra.length === 0) msg += `NESSUNA! La macchina DRA10116 non Ã¨ in anagrafica.\n`;
    else dra.forEach(a => { msg += `  Prog=${a.Progetto} Comp=${a.Componente} Mat=${a.Materiale} CdL=${a.CentroDiLavoro}\n`; });
    msg += `\n--- Materiali in ANAGRAFICA (primi 10) ---\n${anaMateriali.slice(0,10).join(', ')}\n`;
    msg += `\n--- Materiali in DATA (primi 10) ---\n${dataMateriali.slice(0,10).join(', ')}\n`;
    msg += `\n--- Primi 3 record DATA ---\n`;
    sample.forEach(d => { msg += `  Mat="${d.Materiale}" Qta=${d.QuantitaTotale} Prog=${d.Progetto} Rep=${d.Reparto}\n`; });
    alert(msg);
    document.getElementById('debug-dashboard-info').textContent = `ANA: ${ANAGRAFICA.length} | DATA: ${DATA.length} | DRA10116 in ANA: ${dra.length}`;
}

function renderDashboard() {
    const table = document.getElementById('dashboard-table');
    if (!table) return;
    table.innerHTML = '';

    // Definizione colonne per progetto
    const colonneDCT300 = ['SG1', 'DG', 'SG3', 'SG4', 'SG5', 'SG6', 'SG7', 'RW', 'RG'];
    const colonne8Fe = ['SG2', 'SG3', 'SG4', 'SG5', 'SG6', 'SG7', 'SG8', 'PG', 'FG5/7', 'SGR', 'RG', 'Diff mach', 'RG + DH'];
    const colonneEco = ['SG2', 'SG3', 'SG4', 'SG5', 'SGR', 'RG'];

    // Riga 1: Intestazioni principali
    const row1 = table.insertRow();
    row1.insertCell().textContent = 'Tech';
    row1.insertCell().textContent = 'Tot tech';
    row1.insertCell().textContent = 'M/C';
    row1.insertCell().textContent = 'Tot per M/C';
    const dct300H = row1.insertCell();
    dct300H.textContent = 'DCT 300';
    dct300H.colSpan = colonneDCT300.length;
    dct300H.className = 'header-level1';
    const fe8H = row1.insertCell();
    fe8H.textContent = '8Fe';
    fe8H.colSpan = colonne8Fe.length;
    fe8H.className = 'header-level1';
    const ecoH = row1.insertCell();
    ecoH.textContent = 'Eco';
    ecoH.colSpan = colonneEco.length;
    ecoH.className = 'header-level1';

    // Riga 2: Componenti
    const row2 = table.insertRow();
    row2.insertCell(); row2.insertCell(); row2.insertCell(); row2.insertCell();
    colonneDCT300.forEach(comp => { const td = row2.insertCell(); td.textContent = comp; td.className = 'header-level2'; });
    colonne8Fe.forEach(comp => { const td = row2.insertCell(); td.textContent = comp; td.className = 'header-level2'; });
    colonneEco.forEach(comp => { const td = row2.insertCell(); td.textContent = comp; td.className = 'header-level2'; });

    // Elenco macchine
    const macchine = [
        "DRA10060","DRA10061","DRA10062","DRA10063","DRA10064","DRA10065","DRA10066","DRA10067","DRA10068","DRA10069","DRA10070","DRA10071","DRA10072","DRA11042","FRW10077","FRW10193","FRW10217","FRW10076","FRW10078","FRW12464","FRW10074","FRW10075","FRW10082","FRW10140","FRW10079","FRW11980","FRW10081","FRW11010","FRW11022","FRW11016","FRW11017","EGW11005","EGW11008","EGW11014","EGW11015","EGW11016","SCA11008","SCA11009","SCA11010","SCA10151","SCA11006","MZA11005","MZA11006","MZA11008","STW11002","STW11007","STW19069","STW12177","FRD 19013","FRD 19060","ORE19068","TLS 11005","ZSA11019","ZSA11022","RAA11009","TLS 11005","FRA11023","FRA11025","DRA10110","DRA10111","DRA10116","DRA10106","DRA10102","DRA10108","DRA10099","DRA10100","DRA19009","DRA10097","DRA10098","DRA10101","DRA10107","DRA11016","DRA10113","DRA10114","DRA10109","SLW11011","SLW11012","SLW11046","SLW11126","SLW11044","SLW11009","SLW11010","SLW11017","SLW11014","SLW11027","SLW11026","SLW11028","SLW11013","SLW11048","HNW16040","SLA11083","SLA11084","SLA11085","SLA11086","SLA11087","SLA11088","SLA11089","SLA11090","SLA11091","SLA11092","SLA11108","SLA11109","SLA11110","SCA10078","ORE11032","TLS 11013","DRA10058","DRA10059","DRA11044","FRW10189","FRW10073","FRW11015","EGW11006","EGW11007","BOA394","DRA10096","DRA10190","DRA11837","SLW11018","SLW11019","SLW11029","DRA11130","DRA11131","DRA11132","DRA11133","ORE11103","MON12551","SCA11051","TSL11015"
    ];

    // Estrai prefisso tech (prime 3 lettere)
    const getTech = (m) => m.replace(/[^A-Za-z]/g, '').slice(0, 3).toUpperCase();

    // Raggruppa macchine consecutive con lo stesso prefisso tech
    const groups = [];
    let curGroup = null;
    macchine.forEach(m => {
        const tech = getTech(m);
        if (!curGroup || curGroup.tech !== tech) {
            curGroup = { tech, machines: [] };
            groups.push(curGroup);
        }
        curGroup.machines.push(m);
    });

    // Helper: cerca associazione in ANAGRAFICA
    const findAna = (macchina, progetto, componente) =>
        ANAGRAFICA.find(a => a.Macchina === macchina && a.Progetto === progetto && a.Componente === componente);

    // Helper: calcola quantita' da DATA tramite Materiale + Reparto (centro di costo)
    const getQta = (ana) => {
        if (!ana || !DATA || DATA.length === 0) return 0;
        const anaMat = (ana.Materiale || '').toLowerCase().trim();
        const anaRep = (ana.Reparto || '').toLowerCase().trim();
        const matched = DATA.filter(d => {
            const dMat = (d.Materiale || '').toLowerCase().trim();
            const matMatch = dMat === anaMat || dMat.startsWith(anaMat) || anaMat.startsWith(dMat);
            if (!matMatch) return false;
            // Se ANAGRAFICA ha un Reparto (centro di costo), filtra anche per quello
            if (anaRep) {
                const dRep = (d.Reparto || '').toLowerCase().trim();
                return dRep === anaRep;
            }
            return true;
        });
        return matched.reduce((sum, d) => sum + (d.QuantitaTotale || 0), 0);
    };

    // Calcola totale per singola macchina (somma tutte le colonne)
    const getMachineTotal = (m) => {
        let tot = 0;
        colonneDCT300.forEach(comp => { const a = findAna(m, 'DCT 300', comp); tot += getQta(a); });
        colonne8Fe.forEach(comp => { const a = findAna(m, '8Fe', comp); tot += getQta(a); });
        colonneEco.forEach(comp => { const a = findAna(m, 'DCT Eco', comp); tot += getQta(a); });
        return tot;
    };

    // Pre-calcola totali per macchina e per gruppo tech
    const machTotals = {};
    macchine.forEach(m => { machTotals[m] = getMachineTotal(m); });

    // Renderizza righe raggruppate per tech
    groups.forEach(group => {
        const groupTotal = group.machines.reduce((sum, m) => sum + machTotals[m], 0);

        group.machines.forEach((m, idx) => {
            const row = table.insertRow();

            // Tech e Tot tech: solo sulla prima riga del gruppo (rowspan)
            if (idx === 0) {
                const techCell = row.insertCell();
                techCell.textContent = group.tech;
                techCell.rowSpan = group.machines.length;
                techCell.style.fontWeight = '700';
                techCell.style.verticalAlign = 'middle';
                techCell.style.textAlign = 'center';
                techCell.style.background = '#e7e6e6';

                const totTechCell = row.insertCell();
                totTechCell.textContent = groupTotal > 0 ? groupTotal : '';
                totTechCell.rowSpan = group.machines.length;
                totTechCell.className = 'sum-total';
                totTechCell.style.verticalAlign = 'middle';
                totTechCell.style.textAlign = 'center';
                totTechCell.style.fontWeight = '700';
            }

            // M/C
            row.insertCell().textContent = m;

            // Tot per M/C
            const totMCCell = row.insertCell();
            totMCCell.textContent = machTotals[m] > 0 ? machTotals[m] : '';
            totMCCell.style.fontWeight = machTotals[m] > 0 ? '700' : 'normal';
            totMCCell.style.textAlign = 'center';

            // Helper per riempire una cella con debug click
            const fillCell = (progetto, componente, bgColor) => {
                const ana = findAna(m, progetto, componente);
                const td = row.insertCell();
                if (ana) {
                    const qta = getQta(ana);
                    td.textContent = qta > 0 ? qta : '';
                    td.style.background = qta > 0 ? bgColor : '#f5f5f5';
                    td.style.fontWeight = qta > 0 ? '700' : 'normal';
                    td.style.textAlign = 'center';
                    td.title = `${ana.Materiale}\n${ana.CentroDiLavoro || ''} - ${ana.Reparto || ''}`;
                    td.style.cursor = 'pointer';
                    td.addEventListener('click', () => {
                        const anaMat = (ana.Materiale || '').toLowerCase().trim();
                        const allMats = DATA.map(d => d.Materiale).filter((v,i,a) => a.indexOf(v) === i).slice(0, 20);
                        const matched = DATA.filter(d => {
                            const dm = (d.Materiale || '').toLowerCase().trim();
                            return dm === anaMat || dm.startsWith(anaMat) || anaMat.startsWith(dm);
                        });
                        alert(
                            `CELLA: ${m} / ${progetto} / ${componente}\n` +
                            `ANAGRAFICA Materiale: "${ana.Materiale}"\n` +
                            `ANAGRAFICA CdL: "${ana.CentroDiLavoro}"\n` +
                            `---\n` +
                            `DATA totali: ${DATA.length} righe\n` +
                            `Materiali in DATA: ${allMats.join(', ')}\n` +
                            `---\n` +
                            `Righe trovate: ${matched.length}\n` +
                            (matched.length > 0 ? matched.slice(0,3).map(x => `  Mat="${x.Materiale}" Qta=${x.QuantitaTotale} CdL="${x.CentroDiLavoro}"`).join('\n') : '  NESSUN MATCH')
                        );
                    });
                }
            };

            // Celle DCT 300
            colonneDCT300.forEach(comp => fillCell('DCT 300', comp, '#e8f5e9'));
            // Celle 8Fe
            colonne8Fe.forEach(comp => fillCell('8Fe', comp, '#e3f2fd'));
            // Celle Eco
            colonneEco.forEach(comp => fillCell('DCT Eco', comp, '#fff3e0'));
        });
    });
}

function initDashboard() {
    const machSelect = document.getElementById('mach-dashboard');
    if (!machSelect) return;
    const machines = [...new Set(DATA.map(x => x.Reparto))].filter(x => x).sort();
    machSelect.innerHTML = '<option value="">Tutte le macchine</option>' + machines.map(m => `<option value="${m}">${m}</option>`).join('');
    machSelect.addEventListener('change', () => renderDashboard());
    renderDashboard();
}


const TURNI = ['A', 'B', 'C', 'D'];
let TARGETS = {"DCT 300": 0, "8Fe": 0, "DCT Eco": 0, "Altro": 0};
const PROGETTI_ORDER = ['DCT 300', '8Fe', 'DCT Eco', 'Altro'];
const PROGETTI_LISTA = ['DCT 300', '8Fe', 'DCT Eco', 'Altro'];
const BAP1_COMPONENTS = ['SG1', 'DG-Rev', 'DG', 'SG2', 'SG3', 'SG4', 'SG5', 'SG6', 'SG7', 'RG', 'SGR', 'DIFF.LE', 'RG + DH'];
const BAP2_COMPONENTS = ['DGFIX', 'IS1', 'IS2', 'OS1', 'OS2'];
const BAP3_COMPONENTS = [...BAP1_COMPONENTS, ...BAP2_COMPONENTS];
const FESTIVI = ['01-01', '01-06', '04-25', '05-01', '06-02', '08-15', '11-01', '12-08', '12-25', '12-26'];
const SG1_FLUSSO_ORDER = {'Pallinatura': 1, 'Tornitura Hard': 2, 'Rettifica Denti': 3, 'Lavaggio Finale': 4};

function formatDate(d) {
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

function formatDateITA(d) {
    const gg = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
    const mm = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
    return gg[d.getDay()] + ' ' + d.getDate() + ' ' + mm[d.getMonth()] + ' ' + d.getFullYear();
}

function getGiorniLavorativi(anno, mese) {
    const ultimoGiorno = new Date(anno, mese, 0).getDate();
    let lavorativi = 0;
    for (let d = 1; d <= ultimoGiorno; d++) {
        const data = new Date(anno, mese - 1, d);
        if (data.getDay() !== 0 && !FESTIVI.includes(String(d).padStart(2, '0') + '-' + String(mese).padStart(2, '0'))) lavorativi++;
    }
    return lavorativi;
}

let globalState = {
    turni: {search: '', reparto: 'BAP1', progetto: '', componente: '', data: formatDate(new Date())},
    giorno: {search: '', reparto: 'BAP1', progetto: '', componente: '', data: formatDate(new Date())},
    settimana: {search: '', reparto: 'BAP1', progetto: '', componente: '', dataStart: (() => { const d = new Date(); const day = d.getDay(); const diff = day === 0 ? 6 : day - 1; d.setDate(d.getDate() - diff); return formatDate(d); })()},
    mese: {search: '', reparto: 'BAP1', progetto: '', componente: '', anno: new Date().getFullYear(), mese: new Date().getMonth() + 1}
};

function formatNum(n) { return n.toLocaleString('it-IT'); }

function getProgettoOrder(p) { const i = PROGETTI_ORDER.indexOf(p); return i === -1 ? 999 : i; }

function getLavorazioneOrder(c, l) { return (c === 'SG1' && SG1_FLUSSO_ORDER[l]) ? SG1_FLUSSO_ORDER[l] : 999; }

function filterByTurno(turno, state) {
    let f = DATA.filter(x => x.Turno === turno);
    if (state.reparto === 'BAP3') f = f.filter(x => BAP3_COMPONENTS.includes(x.Componente));
    else if (state.reparto !== '') f = f.filter(x => x.Reparto === state.reparto);
    return f.filter(x => (state.search === '' || x.Materiale.toLowerCase().includes(state.search.toLowerCase())) && (state.progetto === '' || x.Progetto === state.progetto) && (state.componente === '' || x.Componente === state.componente))
        .sort((a, b) => { const pa = getProgettoOrder(a.Progetto), pb = getProgettoOrder(b.Progetto); if (pa !== pb) return pa - pb; const oa = getLavorazioneOrder(a.Componente, a.CentroDiLavoro), ob = getLavorazioneOrder(b.Componente, b.CentroDiLavoro); if (oa !== ob) return oa - ob; return a.Materiale.localeCompare(b.Materiale); });
}

function filterByTotale(state) {
    let f = DATA;
    if (state.reparto === 'BAP3') f = f.filter(x => BAP3_COMPONENTS.includes(x.Componente));
    else if (state.reparto !== '') f = f.filter(x => x.Reparto === state.reparto);
    return f.filter(x => (state.search === '' || x.Materiale.toLowerCase().includes(state.search.toLowerCase())) && (state.progetto === '' || x.Progetto === state.progetto) && (state.componente === '' || x.Componente === state.componente));
}

function renderTargetInputs() {
    const c = document.getElementById('target-inputs');
    c.innerHTML = '';
    PROGETTI_LISTA.forEach(p => {
        const g = document.createElement('div');
        g.className = 'target-input-group';
        g.innerHTML = `<label class="target-input-label">${p}</label><input type="number" class="target-input-field" id="target-${p}" value="${TARGETS[p] || 0}" min="0">`;
        c.appendChild(g);
    });
}

function renderTargetSummary() {
    const c = document.getElementById('target-summary');
    c.innerHTML = '';
    const g = getGiorniLavorativi(new Date().getFullYear(), new Date().getMonth() + 1);
    PROGETTI_LISTA.forEach(p => {
        const t = TARGETS[p] || 0;
        const i = document.createElement('div');
        i.style.padding = '0.75rem';
        i.style.borderBottom = '1px solid var(--gray-200)';
        i.innerHTML = `<strong>${p}:</strong> ${t} pz/gg | Turno: ${Math.round(t/4)} | Sett: ${t*6} | Mese: ${t*g}`;
        c.appendChild(i);
    });
}

function renderTurnoCard(turno, state) {
    const f = filterByTurno(turno, state);
    const tot = f.reduce((s, x) => s + x.QuantitaTotale, 0);
    const colors = {A: 'a', B: 'b', C: 'c', D: 'd'};
    const titles = {A: 'Turno A', B: 'Turno B', C: 'Turno C', D: 'Turno D'};
    const icons = {A: 'ğŸ”µ', B: 'ğŸŸ¢', C: 'ğŸŸ¡', D: 'ğŸ”´'};

    // Tabella riepilogo: righe = operazioni, colonne = progetti
    const ops = ['OP10', 'End Soft', 'End Hard'];
    const progetti = ['DCT 300', '8Fe', 'DCT Eco'];
    const pColors = {'DCT 300': '#3b82f6', '8Fe': '#10b981', 'DCT Eco': '#f59e0b'};
    const getVal = (prog, op) => f.filter(x => x.Progetto === prog && (x.CentroDiLavoro || '').toLowerCase().includes(op.toLowerCase())).reduce((s, x) => s + x.QuantitaTotale, 0);
    const totProg = (prog) => f.filter(x => x.Progetto === prog).reduce((s, x) => s + x.QuantitaTotale, 0);
    let statsHTML = `<table style="width:100%;border-collapse:collapse;font-size:1.05rem;margin-top:10px;">` +
        `<thead><tr><td style="padding:8px 10px;"></td>` +
        progetti.map(p => `<th style="padding:8px 12px;text-align:center;font-size:1.1rem;color:${pColors[p]};font-weight:700;border-bottom:3px solid ${pColors[p]};">${p}</th>`).join('') +
        `</tr></thead><tbody>` +
        ops.map(op => `<tr><td style="padding:8px 10px;font-weight:600;font-size:1rem;color:var(--gray-700);">${op}</td>` +
            progetti.map(p => {
                const v = getVal(p, op);
                return `<td style="padding:8px 12px;text-align:center;font-size:1.15rem;font-weight:${v > 0 ? '700' : 'normal'};color:${v > 0 ? 'var(--gray-900)' : '#ccc'};">${v > 0 ? formatNum(v) : '-'}</td>`;
            }).join('') + `</tr>`).join('') +
        `<tr style="border-top:3px solid var(--gray-300);"><td style="padding:8px 10px;font-weight:700;font-size:1rem;">Totale</td>` +
        progetti.map(p => {
            const t = totProg(p);
            return `<td style="padding:8px 12px;text-align:center;font-size:1.2rem;font-weight:700;color:${pColors[p]};">${t > 0 ? formatNum(t) : '-'}</td>`;
        }).join('') + `</tr>` +
        `</tbody></table>`;

    const card = document.createElement('div');
    card.className = 'turno-card turno-card-' + colors[turno];
    const macchine = [
        "DRA10060","DRA10061","DRA10062","DRA10063","DRA10064","DRA10065","DRA10066","DRA10067","DRA10068","DRA10069","DRA10070","DRA10071","DRA10072","DRA11042","FRW10077","FRW10193","FRW10217","FRW10076","FRW10078","FRW12464","FRW10074","FRW10075","FRW10082","FRW10140","FRW10079","FRW11980","FRW10081","FRW11010","FRW11022","FRW11016","FRW11017","EGW11005","EGW11008","EGW11014","EGW11015","EGW11016","SCA11008","SCA11009","SCA11010","SCA10151","SCA11006","MZA11005","MZA11006","MZA11008","STW11002","STW11007","STW19069","STW12177","FRD 19013","FRD 19060","ORE19068","TLS 11005","ZSA11019","ZSA11022","RAA11009","TLS 11005","FRA11023","FRA11025","DRA10110","DRA10111","DRA10116","DRA10106","DRA10102","DRA10108","DRA10099","DRA10100","DRA19009","DRA10097","DRA10098","DRA10101","DRA10107","DRA11016","DRA10113","DRA10114","DRA10109","SLW11011","SLW11012","SLW11046","SLW11126","SLW11044","SLW11009","SLW11010","SLW11017","SLW11014","SLW11027","SLW11026","SLW11028","SLW11013","SLW11048","HNW16040","SLA11083","SLA11084","SLA11085","SLA11086","SLA11087","SLA11088","SLA11089","SLA11090","SLA11091","SLA11092","SLA11108","SLA11109","SLA11110","SCA10078","ORE11032","TLS 11013","DRA10058","DRA10059","DRA11044","FRW10189","FRW10073","FRW11015","EGW11006","EGW11007","BOA394","DRA10096","DRA10190","DRA11837","SLW11018","SLW11019","SLW11029","DRA11130","DRA11131","DRA11132","DRA11133","ORE11103","MON12551","SCA11051","TSL11015"
    ];
    card.innerHTML = `<div class="turno-header"><div class="turno-title" style="color: ${turno==='A'?'#1e40af':turno==='B'?'#065f46':turno==='C'?'#92400e':'#7f1d1d'};"><span>${icons[turno]}</span> ${titles[turno]}</div><div class="turno-stats">${statsHTML}</div></div><div class="turno-content">` + (f.length === 0 ? '<div class="empty-message">Nessun dato</div>' : `<table class="items-table"><thead><tr><th>M/C</th><th>Progetto</th><th>Componente</th><th>Materiale</th><th>Lavorazione</th><th>Prod/Target</th></tr></thead><tbody>` + f.map((item, idx) => {
        const tg = TARGETS[item.Progetto] || 0, tt = Math.round(tg / 4), ok = item.QuantitaTotale >= tt;
        const macchina = macchine[idx % macchine.length];
        return `<tr><td>${macchina}</td><td class="item-progetto">${item.Progetto}</td><td class="item-componente">${item.Componente}</td><td class="item-material">${item.Materiale}</td><td>${item.CentroDiLavoro}</td><td class="item-qty ${ok ? 'qty-ok' : 'qty-fail'}">${ok ? '<span class="check-mark">âœ“</span>' : '<span class="x-mark">âœ•</span>'} ${formatNum(item.QuantitaTotale)}/${tt}</td></tr>`;
    }).join('') + `</tbody></table>`) + `</div>`;

    return card;
}

function renderTotaleTable(filtered, id, type, gg) {
    const agg = {};
    filtered.forEach(item => {
        const k = item.Progetto + '|' + item.Componente + '|' + item.Materiale + '|' + item.CentroDiLavoro;
        if (!agg[k]) agg[k] = {...item, QuantitaTotale: 0};
        agg[k].QuantitaTotale += item.QuantitaTotale;
    });
    
    const rows = Object.values(agg).sort((a, b) => {
        const pa = getProgettoOrder(a.Progetto), pb = getProgettoOrder(b.Progetto);
        if (pa !== pb) return pa - pb;
        return a.Materiale.localeCompare(b.Materiale);
    });
    
    const c = document.getElementById(id);
    c.innerHTML = rows.length === 0 ? '<div class="empty-message">Nessun dato</div>' : `<table class="items-table"><thead><tr><th>Macchina</th><th>Progetto</th><th>Componente</th><th>Materiale</th><th>Lavorazione</th><th>Prod/Target</th></tr></thead><tbody>` + rows.map(item => {
        const tg = TARGETS[item.Progetto] || 0;
        let t = tg;
        if (type === 'turno') t = Math.round(tg / 4);
        else if (type === 'settimana') t = tg * 6;
        else if (type === 'mese') t = tg * gg;
        const ok = item.QuantitaTotale >= t;
        return `<tr><td>${item.Reparto || '-'}</td><td class="item-progetto">${item.Progetto}</td><td class="item-componente">${item.Componente}</td><td class="item-material">${item.Materiale}</td><td>${item.CentroDiLavoro}</td><td class="item-qty ${ok ? 'qty-ok' : 'qty-fail'}">${ok ? '<span class="check-mark">âœ“</span>' : '<span class="x-mark">âœ•</span>'} ${formatNum(item.QuantitaTotale)}/${t}</td></tr>`;
    }).join('') + `</tbody></table>`;
}

function renderTargetSummaryInPage(filtered, id, type, gg) {
    const byP = {};
    filtered.forEach(item => {
        if (!byP[item.Progetto]) byP[item.Progetto] = 0;
        byP[item.Progetto] += item.QuantitaTotale;
    });
    
    const c = document.getElementById(id);
    c.innerHTML = '';
    Object.keys(byP).sort((a, b) => getProgettoOrder(a) - getProgettoOrder(b)).forEach(p => {
        const atual = byP[p], tg = TARGETS[p] || 0;
        let t = tg;
        if (type === 'turno') t = Math.round(tg / 4);
        else if (type === 'settimana') t = tg * 6;
        else if (type === 'mese') t = tg * gg;
        const pct = t > 0 ? Math.round((atual / t) * 100) : 0;
        const item = document.createElement('div');
        item.className = 'target-item';
        item.innerHTML = `<div class="target-label">${p}</div><div class="target-value">${atual}/${t}</div><div class="target-progress"><div class="target-progress-bar" style="width: ${Math.min(pct, 100)}%"></div></div>`;
        c.appendChild(item);
    });
}

function renderTurni(state) {
    const reps = ['BAP1', 'BAP2', 'BAP3'];
    const progs = [...new Set(DATA.map(x => x.Progetto))].sort((a, b) => getProgettoOrder(a) - getProgettoOrder(b));
    const comps = [...new Set(DATA.map(x => x.Componente))].sort();
    
    document.getElementById('date-turni').value = state.data;
    document.getElementById('rep-turni').innerHTML = '<option value="">Tutti</option>' + reps.map(r => `<option value="${r}">${r}</option>`).join('');
    document.getElementById('prog-turni').innerHTML = '<option value="">Tutti</option>' + progs.map(p => `<option value="${p}">${p}</option>`).join('');
    document.getElementById('comp-turni').innerHTML = '<option value="">Tutti</option>' + comps.map(c => `<option value="${c}">${c}</option>`).join('');
    document.getElementById('rep-turni').value = state.reparto;
    document.getElementById('prog-turni').value = state.progetto;
    document.getElementById('comp-turni').value = state.componente;
    
    const grid = document.getElementById('turno-grid');
    grid.innerHTML = '';
    TURNI.forEach(t => grid.appendChild(renderTurnoCard(t, state)));
}

function renderTotale(page, state) {
    const reps = ['BAP1', 'BAP2', 'BAP3'];
    const progs = [...new Set(DATA.map(x => x.Progetto))].sort((a, b) => getProgettoOrder(a) - getProgettoOrder(b));
    const comps = [...new Set(DATA.map(x => x.Componente))].sort();
    
    if (page === 'giorno') {
        document.getElementById('date-giorno').value = state.data;
        document.getElementById('date-info-giorno').textContent = 'ğŸ“… ' + formatDateITA(new Date(state.data));
    } else if (page === 'settimana') {
        document.getElementById('date-start-settimana').value = state.dataStart;
        const d = new Date(state.dataStart);
        const d2 = new Date(d); d2.setDate(d2.getDate() + 5); // Lun â†’ Sab
        // Calcola numero settimana ISO
        const tmp = new Date(d.getTime());
        tmp.setHours(0,0,0,0);
        tmp.setDate(tmp.getDate() + 3 - (tmp.getDay() + 6) % 7);
        const week1 = new Date(tmp.getFullYear(), 0, 4);
        const weekNum = 1 + Math.round(((tmp.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        document.getElementById('date-info-settimana').textContent = 'ğŸ“… Week ' + weekNum + ' â€” ' + formatDateITA(d) + ' â†’ ' + formatDateITA(d2);
    } else if (page === 'mese') {
        const mmm = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        document.getElementById('month-mese').value = state.anno + '-' + String(state.mese).padStart(2, '0');
        document.getElementById('date-info-mese').textContent = 'ğŸ“… ' + mmm[state.mese - 1] + ' ' + state.anno;
    }
    
    document.getElementById('rep-' + page).innerHTML = '<option value="">Tutti</option>' + reps.map(r => `<option value="${r}">${r}</option>`).join('');
    document.getElementById('prog-' + page).innerHTML = '<option value="">Tutti</option>' + progs.map(p => `<option value="${p}">${p}</option>`).join('');
    document.getElementById('comp-' + page).innerHTML = '<option value="">Tutti</option>' + comps.map(c => `<option value="${c}">${c}</option>`).join('');
    document.getElementById('rep-' + page).value = state.reparto;
    document.getElementById('prog-' + page).value = state.progetto;
    document.getElementById('comp-' + page).value = state.componente;
    
    const filtered = filterByTotale(state);
    const cid = page === 'giorno' ? 'giorno-content' : page + '-content';
    const tid = page === 'giorno' ? 'progetto-target' : 'progetto-target-' + (page === 'settimana' ? 'sett' : 'mese');
    let gg = 1;
    if (page === 'settimana') gg = 6;
    else if (page === 'mese') gg = getGiorniLavorativi(state.anno, state.mese);
    
    renderTargetSummaryInPage(filtered, tid, page, gg);
    renderTotaleTable(filtered, cid, page, gg);
}

document.addEventListener('DOMContentLoaded', () => {
    ['dashboard', 'turni', 'giorno', 'settimana', 'mese', 'preview', 'impostazioni'].forEach(p => {
        const btn = document.getElementById('btn-' + p);
        if (btn) {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
                document.getElementById('page-' + p).classList.add('active');
                btn.classList.add('active');
                if (p === 'impostazioni') { renderTargetInputs(); renderTargetSummary(); }
                if (p === 'preview') { renderPreview(); }
            });
        }
    });
    
    document.getElementById('btn-salva-target').addEventListener('click', () => {
        PROGETTI_LISTA.forEach(p => { TARGETS[p] = parseInt(document.getElementById('target-' + p).value) || 0; });
        alert('âœ… Salvato!');
        renderTargetSummary();
        renderTotale('giorno', globalState.giorno);
        renderTotale('settimana', globalState.settimana);
        renderTotale('mese', globalState.mese);
    });
    
    document.getElementById('btn-reset-target').addEventListener('click', () => {
        TARGETS = {"DCT 300": 0, "8Fe": 0, "DCT Eco": 0, "Altro": 0};
        renderTargetInputs();
        renderTargetSummary();
    });
    
    document.getElementById('csv-file').addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const ext = f.name.split('.').pop().toLowerCase();
        if (ext === 'xls' || ext === 'xlsx') {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const workbook = XLSX.read(ev.target.result, {type: 'binary'});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    // Debug: mostra struttura del foglio per trovare la riga di partenza dei dati
                    const ref = sheet['!ref'] || 'N/A';
                    let dbgRows = '';
                    for (let r = 1; r <= 15; r++) {
                        const cells = ['A','B','C','D','E','F','G'].map(c => {
                            const cell = sheet[c + r];
                            return cell ? String(cell.v).substring(0, 20) : '';
                        });
                        dbgRows += `Riga ${r}: ${cells.join(' | ')}\n`;
                    }
                    alert(`DEBUG STRUTTURA EXCEL\nRange: ${ref}\n\n${dbgRows}`);
                    // Trova la riga header cercando "Materiale" nelle prime 20 righe
                    let headerRow = 0;
                    for (let r = 1; r <= 20; r++) {
                        for (const c of ['A','B','C','D','E','F','G','H','I','J']) {
                            const cell = sheet[c + r];
                            if (cell && String(cell.v).toLowerCase().includes('materiale')) {
                                headerRow = r - 1; // sheet_to_json usa indice 0-based
                                break;
                            }
                        }
                        if (headerRow > 0) break;
                    }
                    const json = XLSX.utils.sheet_to_json(sheet, {defval: '', range: headerRow});
                    DATA.length = 0;
                    let n = 0;
                    // Leggi data dalla cella D9
                    let dataAcquisizione = '';
                    const cellD9 = sheet['D9'];
                    if (cellD9) {
                        if (typeof cellD9.v === 'number') {
                            const d = new Date((cellD9.v - 25569) * 86400 * 1000);
                            dataAcquisizione = d.toISOString().slice(0, 10);
                        } else {
                            const raw = String(cellD9.v).trim();
                            const parts = raw.split('/');
                            if (parts.length === 3) {
                                dataAcquisizione = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
                            } else {
                                dataAcquisizione = raw.slice(0, 10);
                            }
                        }
                    }
                    if (!dataAcquisizione) {
                        alert('âš ï¸ Cella D9 vuota o non trovata. Impossibile determinare la data del file.');
                        return;
                    }
                    const findCol = (row, ...keywords) => {
                        for (const key of Object.keys(row)) {
                            const kl = key.toLowerCase().trim();
                            for (const kw of keywords) {
                                if (kl === kw || kl.includes(kw)) return row[key];
                            }
                        }
                        return '';
                    };
                    json.forEach(row => {
                        const materiale = String(findCol(row, 'materiale') || '').trim();
                        const componente = String(findCol(row, 'componente') || '').trim();
                        const lavorazione = String(findCol(row, 'lavorazione', 'centro di lavoro') || '').trim();
                        const turno = String(findCol(row, 'turno') || '').trim();
                        const rawQta = findCol(row, 'quantit', 'qty', 'qta');
                        const quantita = parseInt(String(rawQta).replace(/[^\d-]/g, '')) || 0;
                        const macchina = String(findCol(row, 'macchina', 'reparto') || '').trim();
                        if (!materiale) return;
                        let progetto = 'Altro';
                        let compFinal = componente || 'N/A';
                        let repartoFinal = macchina || 'Da assegnare';
                        let cdlFinal = lavorazione;
                        const matLower = materiale.toLowerCase().trim();
                        const match = ANAGRAFICA.find(a => {
                            const am = (a.Materiale || '').toLowerCase().trim();
                            return am === matLower || matLower.startsWith(am) || am.startsWith(matLower);
                        });
                        if (match) {
                            progetto = match.Progetto;
                            compFinal = match.Componente || compFinal;
                            repartoFinal = match.Reparto || repartoFinal;
                            cdlFinal = match.CentroDiLavoro || cdlFinal;
                        }
                        DATA.push({
                            Progetto: progetto,
                            Materiale: materiale,
                            Componente: compFinal,
                            CentroDiLavoro: cdlFinal,
                            Turno: turno,
                            QuantitaTotale: quantita,
                            Reparto: repartoFinal,
                            DataAcquisizione: dataAcquisizione
                        });
                        n++;
                    });
                    // Salvataggio automatico su Supabase
                    const datePresenti = [...new Set(DATA.map(r => r.DataAcquisizione).filter(d => d))];
                    let supaMsg = '';
                    if (supabase && datePresenti.length > 0) {
                        try {
                            const dates = await saveToSupabase();
                            supaMsg = `\nâ˜ï¸ Salvati su Supabase per data: ${dates.join(', ')}`;
                        } catch (sErr) {
                            supaMsg = `\nâš ï¸ Errore salvataggio Supabase: ${sErr.message}`;
                        }
                    } else if (!supabase) {
                        supaMsg = '\nâš ï¸ Supabase non configurato, dati solo locali';
                    } else {
                        supaMsg = '\nâš ï¸ Nessuna data trovata nella colonna Acquisito';
                    }
                    alert(`âœ… Caricati ${n} record da Excel!${supaMsg}`);
                    renderDashboard();
                    renderTurni(globalState.turni);
                    renderTotale('giorno', globalState.giorno);
                } catch (err) {
                    alert('âŒ Errore Excel: ' + err.message);
                }
            };
            reader.readAsBinaryString(f);
        } else {
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const lines = ev.target.result.split(/\r?\n/).filter(l => l.trim());
                    if (lines.length < 2) throw new Error('CSV vuoto o senza dati');
                    const h = lines[0].split(/\t|;/).map(x => x.trim());
                    const idx = {
                        materiale: h.findIndex(x => x.toLowerCase().includes('materiale')),
                        componente: h.findIndex(x => x.toLowerCase().includes('componente')),
                        lavorazione: h.findIndex(x => x.toLowerCase().includes('lavorazione') || x.toLowerCase().includes('centro di lavoro')),
                        turno: h.findIndex(x => x.toLowerCase().includes('turno')),
                        quantita: h.findIndex(x => x.toLowerCase().includes('quantita')),
                        macchina: h.findIndex(x => x.toLowerCase().includes('macchina') || x.toLowerCase().includes('reparto')),
                        acquisito: h.findIndex(x => x.toLowerCase().includes('acquisito')),
                    };
                    if (idx.materiale === -1 || idx.lavorazione === -1 || idx.quantita === -1) {
                        alert('âŒ Colonne obbligatorie mancanti (Materiale, Lavorazione, QuantitÃ )');
                        return;
                    }
                    // Leggi data dalla cella D9 (riga 9, colonna 4)
                    let dataAcquisizione = '';
                    if (lines.length >= 9) {
                        const row9 = lines[8].split(/\t|;/);
                        const rawD9 = (row9[3] || '').trim();
                        if (rawD9) {
                            const parts = rawD9.split('/');
                            if (parts.length === 3) {
                                dataAcquisizione = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
                            } else {
                                dataAcquisizione = rawD9.slice(0, 10);
                            }
                        }
                    }
                    if (!dataAcquisizione) {
                        alert('âš ï¸ Cella D9 vuota o non trovata nel CSV. Impossibile determinare la data.');
                        return;
                    }
                    let n = 0;
                    DATA.length = 0;
                    for (let i = 1; i < lines.length; i++) {
                        const c = lines[i].split(/\t|;/);
                        if (c.length < 3) continue;
                        const materiale = c[idx.materiale]?.trim() || '';
                        const componente = idx.componente !== -1 ? c[idx.componente]?.trim() : '';
                        const lavorazione = c[idx.lavorazione]?.trim() || '';
                        const turno = idx.turno !== -1 ? c[idx.turno]?.trim() : '';
                        const quantita = parseInt(c[idx.quantita]) || 0;
                        const macchina = idx.macchina !== -1 ? c[idx.macchina]?.trim() : '';
                        if (!materiale) continue;
                        let progetto = 'Altro';
                        let compFinal = componente || 'N/A';
                        let repartoFinal = macchina || 'Da assegnare';
                        let cdlFinal = lavorazione;
                        const matLower = materiale.toLowerCase().trim();
                        const match = ANAGRAFICA.find(a => {
                            const am = (a.Materiale || '').toLowerCase().trim();
                            return am === matLower || matLower.startsWith(am) || am.startsWith(matLower);
                        });
                        if (match) {
                            progetto = match.Progetto;
                            compFinal = match.Componente || compFinal;
                            repartoFinal = match.Reparto || repartoFinal;
                            cdlFinal = match.CentroDiLavoro || cdlFinal;
                        }
                        DATA.push({
                            Progetto: progetto,
                            Materiale: materiale,
                            Componente: compFinal,
                            CentroDiLavoro: cdlFinal,
                            Turno: turno,
                            QuantitaTotale: quantita,
                            Reparto: repartoFinal,
                            DataAcquisizione: dataAcquisizione
                        });
                        n++;
                    }
                    // Salvataggio automatico su Supabase
                    const datePresenti = [...new Set(DATA.map(r => r.DataAcquisizione).filter(d => d))];
                    let supaMsg = '';
                    if (supabase && datePresenti.length > 0) {
                        try {
                            const dates = await saveToSupabase();
                            supaMsg = `\nâ˜ï¸ Salvati su Supabase per data: ${dates.join(', ')}`;
                        } catch (sErr) {
                            supaMsg = `\nâš ï¸ Errore salvataggio Supabase: ${sErr.message}`;
                        }
                    } else if (!supabase) {
                        supaMsg = '\nâš ï¸ Supabase non configurato, dati solo locali';
                    } else {
                        supaMsg = '\nâš ï¸ Nessuna data trovata nella colonna Acquisito';
                    }
                    alert(`âœ… Caricati ${n} record!${supaMsg}`);
                    renderDashboard();
                    renderTurni(globalState.turni);
                    renderTotale('giorno', globalState.giorno);
                } catch (err) {
                    alert('âŒ Errore: ' + err.message);
                }
            };
            reader.readAsText(f);
        }
        e.target.value = '';
    });
    
    ['turni', 'giorno', 'settimana', 'mese'].forEach(p => {
        const s = document.getElementById('search-' + p);
        if (s) s.addEventListener('input', (e) => {
            globalState[p].search = e.target.value;
            if (p === 'dashboard') renderDashboard(); if (p === 'turni') renderTurni(globalState[p]);
            else renderTotale(p, globalState[p]);
        });
        
        const r = document.getElementById('rep-' + p);
        if (r) r.addEventListener('change', (e) => {
            globalState[p].reparto = e.target.value;
            if (p === 'dashboard') renderDashboard(); if (p === 'turni') renderTurni(globalState[p]);
            else renderTotale(p, globalState[p]);
        });
        
        const pr = document.getElementById('prog-' + p);
        if (pr) pr.addEventListener('change', (e) => {
            globalState[p].progetto = e.target.value;
            if (p === 'dashboard') renderDashboard(); if (p === 'turni') renderTurni(globalState[p]);
            else renderTotale(p, globalState[p]);
        });
        
        const c = document.getElementById('comp-' + p);
        if (c) c.addEventListener('change', (e) => {
            globalState[p].componente = e.target.value;
            if (p === 'dashboard') renderDashboard(); if (p === 'turni') renderTurni(globalState[p]);
            else renderTotale(p, globalState[p]);
        });
    });
    
    document.getElementById('date-turni').addEventListener('change', (e) => {
        globalState.turni.data = e.target.value;
        renderTurni(globalState.turni);
    });
    
    document.getElementById('date-giorno').addEventListener('change', (e) => {
        globalState.giorno.data = e.target.value;
        renderTotale('giorno', globalState.giorno);
    });
    
    document.getElementById('date-start-settimana').addEventListener('change', (e) => {
        // Snap al lunedi della settimana selezionata
        const d = new Date(e.target.value);
        const day = d.getDay();
        const diff = day === 0 ? 6 : day - 1;
        d.setDate(d.getDate() - diff);
        globalState.settimana.dataStart = formatDate(d);
        renderTotale('settimana', globalState.settimana);
    });
    
    document.getElementById('month-mese').addEventListener('change', (e) => {
        const [y, m] = e.target.value.split('-');
        globalState.mese.anno = parseInt(y);
        globalState.mese.mese = parseInt(m);
        renderTotale('mese', globalState.mese);
    });
    

    initDashboard();
    renderTurni(globalState.turni);
    renderTotale('giorno', globalState.giorno);
    renderTotale('settimana', globalState.settimana);
    renderTotale('mese', globalState.mese);
});
    </script>
</body>
</html>